
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Theresa & Nolan ‚Äî Word Finder (Rainbow Bright)</title>
<style>
  :root {
    --bgA: #fff3e0; --bgB: #e0f7fa; --ink:#0f172a; --card:#fff;
    --c1:#7c3aed; --c2:#16a34a; --c3:#f59e0b; --c4:#0284c7; --c5:#ef4444; --c6:#06b6d4;
  }
  /* Themes */
  .theme-rainbow { --bgA:#fff3e0; --bgB:#e0f7fa; }
  .theme-sunny   { --bgA:#fff7cc; --bgB:#ffe0b2; }
  .theme-ocean   { --bgA:#dbeafe; --bgB:#cffafe; }
  .theme-jungle  { --bgA:#dcfce7; --bgB:#bbf7d0; }

  * { box-sizing:border-box }
  html,body{ margin:0; padding:0; height:100%; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink) }
  body{ background: linear-gradient(135deg, var(--bgA), var(--bgB)); display:flex; justify-content:center; }
  .app{ width:min(980px,100%); padding:16px; }
  h1{ margin:0 0 8px; font-size:28px; font-weight:700 }
  .sub{ color:#475569; font-size:14px; margin-bottom:16px }
  .panel{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 6px 20px rgba(31,41,55,.12) }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
  .btn{ appearance:none; border:1px solid #cbd5e1; background:#fff; color:#0f172a; border-radius:12px; padding:12px 16px; font-size:16px; font-weight:600; cursor:pointer; transition: transform .05s ease, box-shadow .2s ease }
  .btn:hover{ box-shadow:0 6px 16px rgba(15,23,42,.12) }
  .btn:active{ transform:scale(.98) }
  .pill{ border-radius:999px }
  .primary{ background: linear-gradient(135deg, #22c55e, #16a34a); color:white; border-color:transparent }
  .accent{ background: linear-gradient(135deg, #f59e0b, #ef4444); color:white; border-color:transparent }
  select, input[type='number']{ padding:10px 12px; border-radius:10px; border:1px solid #cbd5e1; font-size:16px }
  .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px }
  @media(min-width:860px){ .cards{ grid-template-columns:repeat(3,1fr) } }
  .card{ background:#fff; border:2px solid #e2e8f0; border-radius:20px; padding:22px; text-align:center; font-size:clamp(22px,5vw,34px); font-weight:700; user-select:none; cursor:pointer; transition:box-shadow .15s ease, transform .05s ease }
  .card:active{ transform:scale(.98) }
  .c1{ border-color:rgba(124,58,237,.22); background:rgba(124,58,237,.10) }
  .c2{ border-color:rgba(22,163,74,.22);  background:rgba(22,163,74,.10)  }
  .c3{ border-color:rgba(245,158,11,.22); background:rgba(245,158,11,.10) }
  .c4{ border-color:rgba(2,132,199,.22);  background:rgba(2,132,199,.10)  }
  .c5{ border-color:rgba(239,68,68,.22);  background:rgba(239,68,68,.10)  }
  .c6{ border-color:rgba(6,182,212,.22);  background:rgba(6,182,212,.10)  }
  .progress{ height:10px; background:#e2e8f0; border-radius:999px; overflow:hidden; margin-bottom:8px }
  .progress>div{ height:100%; background:linear-gradient(90deg,#22c55e,#16a34a); width:0% }
  .hidden{ display:none !important }
  .wordlist{ max-height:220px; overflow:auto; border:1px solid #e2e8f0; border-radius:12px; padding:8px; background:#fff }
  .worditem{ display:flex; align-items:center; gap:8px; padding:6px 4px; border-bottom:1px dashed #e2e8f0 }
  .worditem:last-child{ border-bottom:none }
  .celebrate{ position:fixed; inset:0; background:rgba(255,255,255,.86); backdrop-filter:blur(4px); z-index:10; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center }
  .celebrate h2{ font-size: clamp(28px, 7vw, 56px); margin:0 0 8px }
  canvas#confetti{ position:fixed; inset:0; pointer-events:none; z-index:9 }
</style>
</head>
<body class="theme-rainbow">
<canvas id="confetti"></canvas>
<div class="app">
  <div class="panel">
    <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
      <div>
        <h1>Theresa &amp; Nolan ‚Äî Word Finder</h1>
        <div class="sub">Mixed case ¬∑ 6 choices ¬∑ 25 rounds ¬∑ <span style="padding:6px 10px; background:#f1f5f9; border-radius:999px;">Grandma Mode</span></div>
      </div>
      <div class="row">
        <label>Theme:
          <select id="themeSel">
            <option value="rainbow">Rainbow</option>
            <option value="sunny">Sunny</option>
            <option value="ocean">Ocean</option>
            <option value="jungle">Jungle</option>
          </select>
        </label>
        <button id="btnStart" class="btn primary pill">Start Session</button>
        <button id="btnRepeat" class="btn accent pill">Repeat</button>
      </div>
    </div>

    <div class="progress"><div id="prog"></div></div>

    <div id="practice">
      <div id="prompt" class="sub" style="margin:12px 0 8px;">Find the word‚Ä¶ <strong id="targetWord">_____</strong></div>
      <div id="choices" class="cards"></div>
    </div>

    <div id="celebration" class="celebrate hidden" role="dialog" aria-live="polite">
      <h2>üéâ YAY NOLAN! üéâ</h2>
      <div class="row" style="justify-content:center; margin-top:8px">
        <button id="btnPlayAgain" class="btn primary pill">Play Again</button>
      </div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #e2e8f0">

    <details id="settings">
      <summary class="btn pill" style="display:inline-block;">Grandma Mode (settings)</summary>
      <div class="row" style="margin-top:12px">
        <label>Choices per round: <input type="number" id="inpChoices" min="2" max="8" value="6"/></label>
        <label>Rounds per session: <input type="number" id="inpRounds" min="5" max="50" value="25"/></label>
        <label><input type="checkbox" id="chkSpell" checked/> Also spell it out (S‚ÄëN‚ÄëO‚ÄëW‚Ä¶ snow)</label>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnExport" class="btn pill">Export words</button>
        <label class="btn pill" for="fileImport" style="cursor:pointer;">Import words<input id="fileImport" type="file" accept="application/json" class="hidden"></label>
        <span style="font-size:12px; color:#64748b">Saved privately on this device.</span>
      </div>

      <h3 style="margin:8px 0 6px; font-size:16px">Active Practice List</h3>
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="row">
          <button id="btnSelectAll" class="btn pill">Select all</button>
          <button id="btnClearAll" class="btn pill">Clear all</button>
        </div>
        <span style="font-size:12px; color:#64748b">Tap üéô to record Grandma voice ¬∑ ‚ñ∂Ô∏è to play</span>
      </div>
      <div id="wordList" class="wordlist"></div>
    </details>

  </div>
</div>

<script>
// --- Utilities & State ---
const LS_KEY = "tn_wordfinder_v2";
const shuffle = (arr) => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(p=>p[1]);
const save = (s) => localStorage.setItem(LS_KEY, JSON.stringify(s));
const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || null } catch { return null } };

const DEFAULT = {
  theme: "rainbow",
  choices: 6,
  rounds: 25,
  spell: true,
  library: { words: ["a", "about", "after", "again", "all", "am", "an", "and", "any", "are", "as", "ask", "at", "away", "back", "ball", "be", "because", "been", "before", "best", "better", "big", "black", "blue", "both", "bring", "brown", "but", "by", "call", "came", "can", "carry", "clean", "cold", "come", "cut", "day", "did", "do", "does", "done", "down", "draw", "drink", "eat", "eight", "every", "fall", "far", "fast", "find", "first", "five", "fly", "for", "found", "four", "from", "full", "funny", "gave", "get", "give", "go", "goes", "going", "good", "got", "green", "had", "has", "have", "he", "help", "her", "here", "hers", "him", "his", "hold", "hot", "how", "hurt", "I", "if", "in", "into", "is", "it", "its", "jump", "just", "keep", "kind", "know", "laugh", "let", "light", "like", "little", "live", "long", "look", "make", "many", "may", "me", "more", "most", "much", "must", "my", "myself", "near", "never", "new", "nine", "no", "not", "now", "of", "off", "old", "on", "once", "one", "only", "open", "or", "our", "out", "over", "own", "people", "play", "please", "pretty", "pull", "push", "put", "ran", "read", "red", "ride", "right", "round", "run", "said", "saw", "say", "see", "seven", "shall", "she", "show", "sing", "six", "sleep", "small", "soon", "start", "stop", "take", "tell", "ten", "thank", "that", "the", "their", "them", "then", "there", "these", "they", "think", "this", "those", "three", "to", "today", "together", "too", "try", "two", "under", "up", "upon", "us", "use", "very", "walk", "want", "warm", "was", "wash", "we", "well", "went", "were", "what", "when", "where", "which", "white", "who", "why", "will", "wish", "with", "work", "would", "write", "yellow", "yes", "you", "your"] },
  active: [],
  audioMap: {},       // word -> dataURL (recorded voice)
  missCounts: {},     // word -> # misses
};
let STATE = load() || DEFAULT;
if(!STATE.active || STATE.active.length===0){ STATE.active = STATE.library.words.slice(0,60); }
applyTheme(STATE.theme);

// --- Audio: chime + cheer ---
const AudioKit = {
  ctx: null,
  ctxOk(){ try { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); return true } catch { return false } },
  chime(){
    if(!this.ctxOk()) return;
    const now = this.ctx.currentTime;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.connect(g); g.connect(this.ctx.destination);
    o.type='triangle';
    o.frequency.setValueAtTime(880, now);
    o.frequency.exponentialRampToValueAtTime(1320, now+0.18);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.3, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
    o.start(now); o.stop(now+0.36);
  },
  cheer(){
    if(!this.ctxOk()) return;
    const now = this.ctx.currentTime;
    const end = now + 1.6;
    for(let i=0;i<12;i++){
      const t = now + Math.random()*1.2;
      this.noiseBurst(t, 0.08 + Math.random()*0.05);
    }
    this.whoop(now+0.2, 0.5);
    this.whoop(now+0.8, 0.5);
  },
  noiseBurst(start, dur){
    const sr = 44100;
    const frameCount = Math.floor(sr*dur);
    const buffer = this.ctx.createBuffer(1, frameCount, sr);
    const data = buffer.getChannelData(0);
    for(let i=0;i<frameCount;i++){ data[i] = (Math.random()*2-1) * (1 - i/frameCount); }
    const src = this.ctx.createBufferSource(); src.buffer = buffer;
    const g = this.ctx.createGain();
    src.connect(g); g.connect(this.ctx.destination);
    g.gain.value = 0.25;
    src.start(start);
  },
  whoop(start, dur){
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.connect(g); g.connect(this.ctx.destination);
    o.type='sine';
    o.frequency.setValueAtTime(440, start);
    o.frequency.exponentialRampToValueAtTime(660, start+dur);
    g.gain.setValueAtTime(0.0001, start);
    g.gain.exponentialRampToValueAtTime(0.18, start+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, start+dur);
    o.start(start); o.stop(start+dur);
  }
};

// --- Speech ---
function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// --- Confetti ---
const confetti = (()=>{
  const canvas = document.getElementById('confetti');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  addEventListener('resize', resize); resize();
  let pieces=[];
  function spawn(n=200){
    pieces = Array.from({length:n},()=>({x:Math.random()*canvas.width, y:-20-Math.random()*canvas.height, v:2+Math.random()*3, c:['#ef4444','#f59e0b','#22c55e','#06b6d4','#3b82f6','#a855f7'][Math.floor(Math.random()*6)], a:Math.random()*Math.PI*2, r:6+Math.random()*6}));
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(const p of pieces){
      p.y += p.v; p.x += Math.sin(p.y*0.02); p.a += 0.03;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.a); ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r*0.6); ctx.restore();
    }
    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);
  return { go(){ spawn(240); setTimeout(()=>spawn(0), 2200) } };
})();

// --- Elements ---
const el = {
  themeSel: document.getElementById('themeSel'),
  btnStart: document.getElementById('btnStart'),
  btnRepeat: document.getElementById('btnRepeat'),
  btnPlayAgain: document.getElementById('btnPlayAgain'),
  targetWord: document.getElementById('targetWord'),
  choices: document.getElementById('choices'),
  prog: document.getElementById('prog'),
  celebration: document.getElementById('celebration'),
  inpChoices: document.getElementById('inpChoices'),
  inpRounds: document.getElementById('inpRounds'),
  chkSpell: document.getElementById('chkSpell'),
  wordList: document.getElementById('wordList'),
  btnExport: document.getElementById('btnExport'),
  fileImport: document.getElementById('fileImport'),
  btnSelectAll: document.getElementById('btnSelectAll'),
  btnClearAll: document.getElementById('btnClearAll'),
};

// Init UI
el.themeSel.value = STATE.theme;
el.inpChoices.value = STATE.choices;
el.inpRounds.value = STATE.rounds;
el.chkSpell.checked = STATE.spell;

// Theme handling
function applyTheme(name){
  document.body.classList.remove("theme-rainbow","theme-sunny","theme-ocean","theme-jungle");
  document.body.classList.add("theme-"+name);
}
el.themeSel.addEventListener('change', ()=>{ STATE.theme = el.themeSel.value; save(STATE); applyTheme(STATE.theme); });

// Build word list with record/play
function renderWordList(){
  const activeSet = new Set(STATE.active);
  el.wordList.innerHTML='';
  for(const w of STATE.library.words){
    const row = document.createElement('div');
    row.className='worditem';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = activeSet.has(w);
    cb.addEventListener('change', ()=>{
      if(cb.checked) STATE.active.push(w); else STATE.active = STATE.active.filter(x=>x!==w);
      STATE.active = Array.from(new Set(STATE.active)); save(STATE);
    });
    const lab = document.createElement('label'); lab.textContent = w; lab.style.flex='1';
    const recBtn = document.createElement('button'); recBtn.className='btn pill'; recBtn.textContent='üéô'; recBtn.title='Record Grandma voice';
    recBtn.addEventListener('click', ()=>recordWord(w, recBtn));
    const playBtn = document.createElement('button'); playBtn.className='btn pill'; playBtn.textContent='‚ñ∂Ô∏è';
    playBtn.addEventListener('click', ()=>playWordAudio(w));
    row.append(cb, lab, recBtn, playBtn);
    el.wordList.appendChild(row);
  }
}
renderWordList();

// Recording per word (stores dataURL)
async function recordWord(word, btn){
  if(!navigator.mediaDevices || !window.MediaRecorder){ alert("Recording not supported on this device/browser."); return; }
  btn.disabled = true; btn.textContent='‚è∫‚Ä¶';
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const rec = new MediaRecorder(stream);
  const chunks = [];
  rec.ondataavailable = (e)=>chunks.push(e.data);
  rec.onstop = async ()=>{
    stream.getTracks().forEach(t=>t.stop());
    const blob = new Blob(chunks, {type:'audio/webm'});
    const reader = new FileReader();
    reader.onloadend = ()=>{
      STATE.audioMap[word] = reader.result; // data URL
      save(STATE);
      btn.disabled=false; btn.textContent='üéô';
    };
    reader.readAsDataURL(blob);
  };
  rec.start();
  setTimeout(()=>rec.stop(), 1800); // ~1.8s
}

// Play recorded or fallback TTS
function playWordAudio(word){
  const data = STATE.audioMap[word];
  if(data){
    const a = new Audio(data); a.play();
  } else {
    speak(word);
  }
}

// Session logic with repeat-bias on misses
let session = null;
function newSession(){
  const pool = (STATE.active && STATE.active.length>0) ? [...STATE.active] : [...STATE.library.words];
  if(pool.length < STATE.choices){ alert('Please select more words in Grandma Mode.'); return; }

  // Weighted selection: base weight 1, add 2 per miss
  function weight(w){ return 1 + (STATE.missCounts[w]||0)*2; }
  const bag = [];
  for(const w of pool){
    const n = weight(w);
    for(let i=0;i<n;i++) bag.push(w);
  }
  const targets = [];
  while(targets.length < Math.min(STATE.rounds, pool.length*4)){
    targets.push(bag[Math.floor(Math.random()*bag.length)]);
  }

  const rounds = targets.map(target=>{
    const others = shuffle(pool.filter(x=>x!==target)).slice(0, STATE.choices-1);
    return { target, choices: shuffle([target, ...others]) };
  });

  session = { i:0, rounds: rounds, corrects:0 };
  el.celebration.classList.add('hidden');
  renderRound();
  setTimeout(()=>repeatPrompt(), 200);
}

function renderRound(){
  const r = session.rounds[session.i];
  document.getElementById('targetWord').textContent = r.target;
  el.choices.innerHTML='';
  const colors = ['c1','c2','c3','c4','c5','c6'];
  r.choices.forEach((c,idx)=>{
    const b = document.createElement('button');
    b.className = 'card ' + colors[idx%colors.length];
    b.textContent = c;
    b.addEventListener('click', ()=>pick(c));
    el.choices.appendChild(b);
  });
  document.getElementById('prog').style.width = Math.round((session.i)/(session.rounds.length)*100) + '%';
}

function currentTarget(){ return session.rounds[session.i].target; }
function repeatPrompt(){
  const t = currentTarget();
  if(STATE.audioMap[t]){ const a = new Audio(STATE.audioMap[t]); a.play(); setTimeout(()=>STATE.spell&&speak(t.split('').join(' - ') + '. ' + t), 50); }
  else { const say = STATE.spell ? t.split('').join(' - ') + '. ' + t : t; speak(say); }
}

function pick(choice){
  const t = currentTarget();
  if(choice === t){
    AudioKit.chime();
    session.corrects++;
    setTimeout(nextRound, 420);
  } else {
    STATE.missCounts[t] = (STATE.missCounts[t]||0) + 1;
    save(STATE);
    setTimeout(repeatPrompt, 200);
  }
}

function nextRound(){
  if(session.i < session.rounds.length-1){
    session.i++; renderRound(); setTimeout(repeatPrompt, 150);
  } else {
    document.getElementById('prog').style.width = '100%';
    celebrate();
  }
}

function celebrate(){
  el.celebration.classList.remove('hidden');
  confetti.go();
  AudioKit.cheer();
}

// Wire up
document.getElementById('btnStart').addEventListener('click', newSession);
document.getElementById('btnRepeat').addEventListener('click', repeatPrompt);
document.getElementById('btnPlayAgain').addEventListener('click', newSession);

// Settings events
el.inpChoices.addEventListener('change', ()=>{ STATE.choices = Math.max(2, Math.min(8, parseInt(el.inpChoices.value||6))); save(STATE); });
el.inpRounds.addEventListener('change', ()=>{ STATE.rounds = Math.max(5, Math.min(50, parseInt(el.inpRounds.value||25))); save(STATE); });
el.chkSpell.addEventListener('change', ()=>{ STATE.spell = !!el.chkSpell.checked; save(STATE); });

// Import/Export
document.getElementById('btnExport').addEventListener('click', ()=>{
  const data = new Blob([JSON.stringify({ library: STATE.library, active: STATE.active, audioMap: STATE.audioMap }, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(data);
  const a = document.createElement('a'); a.href=url; a.download='tn-words.json'; a.click(); URL.revokeObjectURL(url);
});
document.getElementById('fileImport').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try {
    const j = JSON.parse(txt);
    if(j.library && Array.isArray(j.library.words)) STATE.library.words = j.library.words;
    if(Array.isArray(j.active)) STATE.active = j.active;
    if(j.audioMap) STATE.audioMap = j.audioMap;
    save(STATE); renderWordList();
  } catch(e) { alert('Could not read that file.'); }
});
</script>
</body>
</html>
